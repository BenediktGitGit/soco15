<!doctype html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="c3arch/c3.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap-theme.min.css" type="text/css">
    <link rel="stylesheet" href="bootstrap-datepicker-1.5.0-dist/css/bootstrap-datepicker.standalone.min.css" type="text/css">
    <link rel="stylesheet" href="bootstrap-datepicker-1.5.0-dist/css/bootstrap-datepicker.min.css" type="text/css">
    <link rel="stylesheet" href="bootstrap-datepicker-1.5.0-dist/css/bootstrap-datepicker3.min.css" type="text/css">
    <link rel="stylesheet" href="bootstrap-datepicker-1.5.0-dist/css/bootstrap-datepicker3.standalone.min.css" type="text/css">


    <link rel="stylesheet" href="css/main.css" type="text/css">

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>-->
    <script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
    <!--<script type="text/javascript" src="js/jquery-ui-1.7.2.min.js"></script>-->
    <script type="text/javascript" src="bootstrap-datepicker-1.5.0-dist/js/bootstrap-datepicker.min.js"></script>


</head>
<body>
<h1>Stockmarket Prediction - Neural Network Analysis Board</h1>

<script src="d3-master/d3.min.js" charset="utf-8"></script>
<script src="c3arch/c3.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script type="text/javascript" src="canvasjs-1.7.0/canvasjs.min.js"></script>
<script type="text/javascript" src="bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://malsup.github.com/jquery.form.js"></script>


    <script src="js/main.js"></script>

<!--<div class="panel">-->
    <!--<div id="time-panel"></div>-->
    <!--<div id="analyisis-panel"></div>-->
<!--</div>-->

<div class="container-fluid">
    <div class="row">
        <div class="col-xs-2"></div>
        <form id="form">
            <div class="col-md-1 col-lg-offset-1" id="start-date-container">
                <input class="date_field" type="startDate"></div>
            <div class="col-md-1 col-lg-offset-1" id="end-date-container">
                <input class="date_field" type="endDate"></div>
            <div class="col-md-1" id="dataset-container">
                <div class="container-fluid">
                    <div class="row">
                        <select id="dataset_field"></select></div>
                    <div class="row">
                        <select id="ann_field" name="ann_field" ></select></div>
                    </div>
                </div>
            <div class="col-md-1 col-lg-offset-1">
                <input id="submit_btn" type="submit" value="Test Timeseries"/>
            </div>
        </form>
    </div>
</div>

<div class="charts-Box" style="margin-left: 10%; margin-right: 10%; ">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-sm-offset-0 col-md-offset-0">
                <div class="row">
                    <div class="col-xs-6">
                        <div id="chart"></div>
                    </div>
                    <div class="col-md-2">
                        <div class="prompt-boxes">
                            <div class="row">
                                <div class="col-xs-12">
                                    <div id="real_acctual" class="prompt-container">real</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <div id="pred_acctual" class="prompt-container">predicted</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <div id="accurrancy" class="prompt-container">accuracy</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-4">
                        <div id="donut"></div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-6">
                    <div id="line_chart_abs"></div>
                </div>
                <div class="col-xs-6">
                    <div id="mse_chart"></div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-2">
                </div>
                <div class="col-md-8">
                    <div id="v_interval"></div>
                </div>
                <!--<div class="col-xs-2">-->
                <!--<input id="pause_btn" type="button" value="pause" />-->
                <!--</div>-->
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

    var base_url = 'http://localhost:8080/stock';
    var data_url = base_url + '/data';
    var ann_url = base_url + '/ann_names';
    var dataset_url = base_url + '/datasets';

    var chartgen = 0;
    var donut = 0;
    var mse_chart = 0;
    var line_chart_abs=0;


    var i = 1;

    var interval = 1500;
    var real_output_list = Create2DArray(6);
    var predicted_output_list = Create2DArray(6);
    var dist = Create2DArray(3);
    var dist_helper = Create2DArray(3);
    var abs_helper = Create2DArray(2);

    var timer = 0;

    var mse_data = ['MSE', 150];

    var start_date_container = $('#start-date-container input').datepicker();
    var end_date_container =  $('#end-date-container input').datepicker();

    var startDate = 0;
    var endDate = 0;

//    var flag = true;
//    function pause(){
//        if (flag){
//            setTimeout(pause(), 100);
//        }
//    }
//
//    function stop(){
//        flag = false;
//    }
    renderSelects(ann_url, 'ann_field');
    renderSelects(dataset_url, 'dataset_field');

    function renderSelects(url, field) {
        $.ajax({
            url: url,
            async: false,
            success: function(data) {
                console.log(JSON.stringify(data));
            },
            error: function() {
                alert("Error with Rest-Service.");
            }
        }).done(function(data) {
            $.each( data, function( key, value ) {
                var select = '#'+field;
                $(select).append(
                        $('<option></option>').val(key).html(value)
                );
            });
        });
    }


    function formatDates(date) {
        if (date != null) {
            var dd = date.getDate();
            var mm = date.getMonth() + 1;
            var yyyy = date.getFullYear();
            if (dd < 10) {
                dd = '0' + dd
            }
            if (mm < 10) {
                mm = '0' + mm
            }
            return yyyy + '-' + mm + '-' + dd;
        }
        return "";
    }

    $(".date_field").change(function() {
        startDate = start_date_container.datepicker('getDate');
        startDate = formatDates(startDate);

        endDate = end_date_container.datepicker('getDate');
        endDate = formatDates(endDate);
    });



    $( "#submit_btn" ).click(function( event ) {

        var collapse = "daily";
        var target_url = data_url + "?startDate=" + startDate + "&endDate=" + endDate + "&collapse=" + collapse;

        if ( startDate.length === 0)  {
            alert("StartDate is missing.");
        } else if ( endDate.length === 0){
            alert("EndDate is missing.");
        }
        else {
//            $.get( target_url, function( data ) {
//                alert( "Load was performed." );
//            });
            $.ajax({
                url: target_url,
                async: false,
                success: function(data) {
                    alert(data);
//            console.log(JSON.stringify(data.dataset_data));
                    alert("success");
                },
                error: function() {
                    alert("Error with Rest-Service.");
                }
            }).done(function() {
                      alert("done");
                    });
        }
    });



    // GET predicted & real Value List

    real_output_list[0] = ['real output', 30, 200, 100, 400, 150];
    real_output_list[1] = ['real output', 200, 100, 400, 400, 300];
    real_output_list[2] = ['real output', 100, 400, 400, 300, 270];
    real_output_list[3] = ['real output', 400, 400, 300, 290, 290];
    real_output_list[4] = ['real output', 400, 300, 290, 290, 123];
    real_output_list[5] = ['real output', 300, 290, 290, 123, 190];


    predicted_output_list[0] = ['predicted output', 50, 20, 10, 40, 15];
    predicted_output_list[1] = ['predicted output', 20, 10, 40, 15, 70];
    predicted_output_list[2] = ['predicted output', 10, 40, 15, 70, 120];
    predicted_output_list[3] = ['predicted output', 40, 15, 70, 120, 79];
    predicted_output_list[4] = ['predicted output', 15, 70, 120, 79, 143];
    predicted_output_list[5] = ['predicted output', 70, 120, 79, 123, 188];

    abs_helper[0] = real_output_list[0];
    abs_helper[1] = predicted_output_list[0];

    ro_output = real_output_list[0][0];
    po_output = predicted_output_list[0][0];


    // GET Distribution List of Value List
    dist[0].push(['under', 1]);
    dist[1].push(['equal', 0]);
    dist[2].push(['over', 0]);
    dist[0].push(['under', 0]);
    dist[1].push(['equal', 1]);
    dist[2].push(['over', 0]);
    dist[0].push(['under', 0]);
    dist[1].push(['equal', 0]);
    dist[2].push(['over', 1]);
    dist[0].push(['under', 0]);
    dist[1].push(['equal', 0]);
    dist[2].push(['over', 1]);
    dist[0].push(['under', 1]);
    dist[1].push(['equal', 0]);
    dist[2].push(['over', 0]);
    dist[0].push(['under', 1]);
    dist[1].push(['equal', 0]);
    dist[2].push(['over', 0]);

    dist_helper[0] = dist[0][0];
    dist_helper[1] = dist[1][0];
    dist_helper[2] = dist[2][0];

    under_cap = dist[0][0];
    over_cap = dist[1][0];
    equal_cap = dist[2][0];

    chartgen = initChart('chart', [ abs_helper[0], abs_helper[1] ], ['orange', 'yellow'], 'volume', 'DAX (single period)'); // initChartProcessing();
    donut = initDonutProcessing();
    mse_chart = initChart('mse_chart', [ mse_data ], ['red'], 'volume', 'MSE'); //initMseChart();
    line_chart_abs = initChart('line_chart_abs', [ abs_helper[0], abs_helper[1] ], ['green', 'yellow'], 'volume', 'DAX (abs)'); // initlineChartAbs();
    timer = loadCharts(i, predicted_output_list.length);


    function Create2DArray(rows) {
        var arr = [];

        for (var i=0;i<rows;i++) {
            arr[i] = [];
        }

        return arr;
    }

    function initChart(bindTo, cols, colors, xLabel, yLabel) {
        renderSpeedSlider();
//        renderPauseBtn();
        return c3.generate({
            x: bindTo,
            bindto: '#' + bindTo,
            data: {
                columns: cols
            },
            axis: {
                x: {
                    label: {
                        text: xLabel,
                        position: 'outer-middle'
                    }
                },
                y: {
                    label: {
                        text: yLabel,
                        position: 'outer-middle'
                    }
                }
            },
            grid: {
                y: {
                    show: true
                }
            },
            color: {
                pattern: colors
            }
        });
    }

//    function renderPauseBtn() {
////        $('#pause').html("<input id=\"pause_btn\" type=\"button\" value=\"pause\" />");
//        $('#pause_btn').click(function () {
//            if ($('#pause_btn').val() == 'pause') {
//                $('#pause_btn').val('stopped');
//                pause();
//            }
//            else {
//                $('#pause_btn').val('pause');
//                stop();
//             }
//        });
//    }

    function renderSpeedSlider() {
        $('#v_interval').html("<input id=\"velocity\" type=" + "\"range\"" + " name" + "=" + "\"velocity\"" +" min=\"0\" max=" + "\"3000\"" + " value=\"" + interval + "\">");

        $('#velocity').change(function() {
            interval = $('#velocity').val();
        })

//        <input type="range" name="auswertung" min="0" max="10" value="5">
//        Punkte: <output name="numerisch">5</output>
//
//        </form>
    }

    function initDonutProcessing() {
        return c3.generate({
            data: {
                columns: [
                    dist_helper[0],
                    dist_helper[1],
                    dist_helper[2]
                ],
                type: 'donut',
                onclick: function (d, i) {
                    console.log("onclick", d, i);
                },
                onmouseover: function (d, i) {
                    console.log("onmouseover", d, i);
                },
                onmouseout: function (d, i) {
                    console.log("onmouseout", d, i);
                }
            },
            transition: {
                duration: 120
            },
            color: {
                pattern: ['orange', 'yellow', 'green']
            },
            donut: {
                title: "Distribution"
            },
            bindto: "#donut"
        });

        return donut;
    }

    function loadCharts(i, length) {
      return  setTimeout(function () {
            var ro_acctual = real_output_list[i][real_output_list[i].length-1];
            var po_acctual = predicted_output_list[i][predicted_output_list[i].length-1];
            var accurrancy = ro_acctual / po_acctual;
            if(accurrancy > 1) {
                accurrancy = (po_acctual / ro_acctual) * 100;
            }
            else {
                accurrancy = accurrancy * 100;
            }
            accurrancy = accurrancy.toPrecision(4);

            abs_helper[0].push(ro_acctual);
            abs_helper[1].push(po_acctual);

            dist_helper[0].push(dist[0][i][1]);
            dist_helper[1].push(dist[1][i][1]);
            dist_helper[2].push(dist[2][i][1]);

            $('#real_acctual').html('real: ' + ro_acctual);
            $('#pred_acctual').html('predicted: ' + po_acctual);
            $('#accurrancy').html('accuracy: ' + accurrancy + ' %');

            chartgen.load({
                columns: [
                    real_output_list[i],
                    predicted_output_list[i]
                ]
            });
            line_chart_abs.load({
                columns: [
                    abs_helper[0],
                    abs_helper[1]
                ]
            });
            donut.load({
                columns: [
                    dist_helper[0],
                    dist_helper[1],
                    dist_helper[2]
                ]
            });
//            dps_iter.push(dps_json[i]);
            mse_data.push(ro_acctual-po_acctual);
            mse_chart.load({
                columns: [
                    mse_data
                   ]
            });
//            mse_chart.render();
            i++;
            if (i < length) {
                loadCharts(i, length);
            }
        }, interval);
    }

</script>


</body>
</html>
